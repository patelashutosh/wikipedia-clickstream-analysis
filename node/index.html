<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>

<script src="/socket.io/socket.io.js"></script>


<figure class="highcharts-figure">
    <div id="container"></div>
    <p class="highcharts-description">
        Chart showing use of rotated axis labels and data labels.
    </p>
</figure>

<script type="text/javascript">

    $(document).ready(function () {
	    var socket = io();
	    var series;
        var chartData = new Map();

        function processMap(mapData) {
            var map = new Map([...mapData.entries()].sort((a, b) => b[1] - a[1]));
            return map;
        }

        function convertToArray(mapData, n) {
            var arrs = new Array();
            var i = 0;
            for (let [key, value] of mapData.entries()) {
                    //console.log("value", value)
                    value = parseInt(value);
                    var arr = [key, value];
                    arrs.push(arr);
                    if (i++ == n) {
                        break;
                }
            }
            return arrs;
        }

        Highcharts.setOptions({
            global: {
                useUTC: false
            },
            lang: {
                thousandsSep: ','
            }
        });

        var options = {
            chart: {
            renderTo: 'container',
            type: 'column',
            // options3d: {
            //     enabled: true,
            //     alpha: 0,
            //     beta: 0,
            //     depth: 0,
            //     viewDistance: 25
            // }
            },
            title: {
                text: 'Most accessed pages on wikipedia'
            },
            subtitle: {
                text: 'Source: <a href="http://en.wikipedia.org/wiki/List_of_cities_proper_by_population">Wikipedia</a>'
            },
            xAxis: {
                type: 'category',
                //type: 'Page name',
                //categories: ['Apples', 'Oranges', 'Bananas'],
                // labels: {
                //     rotation: -45,
                //     style: {
                //         fontSize: '13px',
                //         fontFamily: 'Verdana, sans-serif'
                //     }
                // }
                crosshair: true
            },
            yAxis: {
                min: 0,
                title: {
                    text: 'View count'
                }
            },
            legend: {
                enabled: false
            },
            tooltip: {
                pointFormat: 'View count <b>{point.y}</b>'
            },
            plotOptions: {
                column: {
                    pointPadding: 0.2,
                    borderWidth: 0
                }
            },
            series: [{
                name: 'Articles',
                data: [],
                dataLabels: {
                    enabled: true,
                    rotation: -90,
                    color: '#FFFFFF',
                    align: 'right',
                    //format: '{point.y:.1f}', // one decimal
                    y: 10, // 10 pixels down from the top
                    style: {
                        fontSize: '13px',
                        fontFamily: 'Verdana, sans-serif'
                    }
                }
            }]
        };
        var chart = new Highcharts.Chart(options);
        socket.on('message', function(msgs){
            for(let msg of msgs) {
                console.log(msg.key, msg.value);
                chartData.set(msg.key, msg.value);
                chartData = processMap(chartData);
                var data = convertToArray(chartData, 10); //take top 10
                chart.series[0].setData(data);
            }
            chart.redraw();
        });
    });
</script>
